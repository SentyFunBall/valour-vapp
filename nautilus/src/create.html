<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Project</title>
    <link rel="stylesheet" href="create.css">
    
</head>
<body>
    <div id="blok" style="background-color: #1f1f1f;">
        
    </div>
    <!-- blockly stuff -->
    <script type="module" src="./blocks/stub.js"></script>
    <script type="module" src="./blocks/define.js"></script>
    <script src="./../blockly/blockly_compressed.js"></script>
    <script src="./../blockly/blocks_compressed.js"></script>
    <script src="./../blockly/javascript_compressed.js"></script>
    <script src="./../blockly/msg/js/en.js"></script> <!-- was this path brruh-->
    <!-- xml things -->
    <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
        <category name="Logic" colour="%{BKY_LOGIC_HUE}">
          <block type="controls_if"></block>
          <block type="logic_compare"></block>
          <block type="logic_operation"></block>
          <block type="logic_negate"></block>
          <block type="logic_boolean"></block>
          <block type="logic_null"></block>
          <block type="logic_ternary"></block>
        </category>
        <category name="Loops" colour="%{BKY_LOOPS_HUE}">
          <block type="controls_repeat_ext">
            <value name="TIMES">
              <shadow type="math_number">
                <field name="NUM">10</field>
              </shadow>
            </value>
          </block>
          <block type="controls_whileUntil"></block>
          <block type="controls_for">
            <value name="FROM">
              <shadow type="math_number">
                <field name="NUM">1</field>
              </shadow>
            </value>
            <value name="TO">
              <shadow type="math_number">
                <field name="NUM">10</field>
              </shadow>
            </value>
            <value name="BY">
              <shadow type="math_number">
                <field name="NUM">1</field>
              </shadow>
            </value>
          </block>
          <block type="controls_forEach"></block>
          <block type="controls_flow_statements"></block>
        </category>
        <category name="Math" colour="%{BKY_MATH_HUE}">
          <block type="math_number">
            <field name="NUM">123</field>
          </block>
          <block type="math_arithmetic">
            <value name="A">
              <shadow type="math_number">
                <field name="NUM">1</field>
              </shadow>
            </value>
            <value name="B">
              <shadow type="math_number">
                <field name="NUM">1</field>
              </shadow>
            </value>
          </block>
          <block type="math_single">
            <value name="NUM">
              <shadow type="math_number">
                <field name="NUM">9</field>
              </shadow>
            </value>
          </block>
          <block type="math_trig">
            <value name="NUM">
              <shadow type="math_number">
                <field name="NUM">45</field>
              </shadow>
            </value>
          </block>
          <block type="math_constant"></block>
          <block type="math_number_property">
            <value name="NUMBER_TO_CHECK">
              <shadow type="math_number">
                <field name="NUM">0</field>
              </shadow>
            </value>
          </block>
          <block type="math_round">
            <value name="NUM">
              <shadow type="math_number">
                <field name="NUM">3.1</field>
              </shadow>
            </value>
          </block>
          <block type="math_on_list"></block>
          <block type="math_modulo">
            <value name="DIVIDEND">
              <shadow type="math_number">
                <field name="NUM">64</field>
              </shadow>
            </value>
            <value name="DIVISOR">
              <shadow type="math_number">
                <field name="NUM">10</field>
              </shadow>
            </value>
          </block>
          <block type="math_constrain">
            <value name="VALUE">
              <shadow type="math_number">
                <field name="NUM">50</field>
              </shadow>
            </value>
            <value name="LOW">
              <shadow type="math_number">
                <field name="NUM">1</field>
              </shadow>
            </value>
            <value name="HIGH">
              <shadow type="math_number">
                <field name="NUM">100</field>
              </shadow>
            </value>
          </block>
          <block type="math_random_int">
            <value name="FROM">
              <shadow type="math_number">
                <field name="NUM">1</field>
              </shadow>
            </value>
            <value name="TO">
              <shadow type="math_number">
                <field name="NUM">100</field>
              </shadow>
            </value>
          </block>
          <block type="math_random_float"></block>
          <block type="math_atan2">
            <value name="X">
              <shadow type="math_number">
                <field name="NUM">1</field>
              </shadow>
            </value>
            <value name="Y">
              <shadow type="math_number">
                <field name="NUM">1</field>
              </shadow>
            </value>
          </block>
        </category>
        <category name="Text" colour="%{BKY_TEXTS_HUE}">
          <block type="text"></block>
          <block type="text_join"></block>
          <block type="text_append">
            <value name="TEXT">
              <shadow type="text"></shadow>
            </value>
          </block>
          <block type="text_length">
            <value name="VALUE">
              <shadow type="text">
                <field name="TEXT">abc</field>
              </shadow>
            </value>
          </block>
          <block type="text_isEmpty">
            <value name="VALUE">
              <shadow type="text">
                <field name="TEXT"></field>
              </shadow>
            </value>
          </block>
          <block type="text_indexOf">
            <value name="VALUE">
              <block type="variables_get">
                <field name="VAR">{textVariable}</field>
              </block>
            </value>
            <value name="FIND">
              <shadow type="text">
                <field name="TEXT">abc</field>
              </shadow>
            </value>
          </block>
          <block type="text_charAt">
            <value name="VALUE">
              <block type="variables_get">
                <field name="VAR">{textVariable}</field>
              </block>
            </value>
          </block>
          <block type="text_getSubstring">
            <value name="STRING">
              <block type="variables_get">
                <field name="VAR">{textVariable}</field>
              </block>
            </value>
          </block>
          <block type="text_changeCase">
            <value name="TEXT">
              <shadow type="text">
                <field name="TEXT">abc</field>
              </shadow>
            </value>
          </block>
          <block type="text_trim">
            <value name="TEXT">
              <shadow type="text">
                <field name="TEXT">abc</field>
              </shadow>
            </value>
          </block>
          <block type="text_print">
            <value name="TEXT">
              <shadow type="text">
                <field name="TEXT">abc</field>
              </shadow>
            </value>
          </block>
          <block type="text_prompt_ext">
            <value name="TEXT">
              <shadow type="text">
                <field name="TEXT">abc</field>
              </shadow>
            </value>
          </block>
        </category>
        <category name="Lists" colour="%{BKY_LISTS_HUE}">
          <block type="lists_create_with">
            <mutation items="0"></mutation>
          </block>
          <block type="lists_create_with"></block>
          <block type="lists_repeat">
            <value name="NUM">
              <shadow type="math_number">
                <field name="NUM">5</field>
              </shadow>
            </value>
          </block>
          <block type="lists_length"></block>
          <block type="lists_isEmpty"></block>
          <block type="lists_indexOf">
            <value name="VALUE">
              <block type="variables_get">
                <field name="VAR">{listVariable}</field>
              </block>
            </value>
          </block>
          <block type="lists_getIndex">
            <value name="VALUE">
              <block type="variables_get">
                <field name="VAR">{listVariable}</field>
              </block>
            </value>
          </block>
          <block type="lists_setIndex">
            <value name="LIST">
              <block type="variables_get">
                <field name="VAR">{listVariable}</field>
              </block>
            </value>
          </block>
          <block type="lists_getSublist">
            <value name="LIST">
              <block type="variables_get">
                <field name="VAR">{listVariable}</field>
              </block>
            </value>
          </block>
          <block type="lists_split">
            <value name="DELIM">
              <shadow type="text">
                <field name="TEXT">,</field>
              </shadow>
            </value>
          </block>
          <block type="lists_sort"></block>
        </category>
        <category name="Color" colour="%{BKY_COLOUR_HUE}">
          <block type="colour_picker"></block>
          <block type="colour_random"></block>
          <block type="colour_rgb">
            <value name="RED">
              <shadow type="math_number">
                <field name="NUM">100</field>
              </shadow>
            </value>
            <value name="GREEN">
              <shadow type="math_number">
                <field name="NUM">50</field>
              </shadow>
            </value>
            <value name="BLUE">
              <shadow type="math_number">
                <field name="NUM">0</field>
              </shadow>
            </value>
          </block>
          <block type="colour_blend">
            <value name="COLOUR1">
              <shadow type="colour_picker">
                <field name="COLOUR">#ff0000</field>
              </shadow>
            </value>
            <value name="COLOUR2">
              <shadow type="colour_picker">
                <field name="COLOUR">#3333ff</field>
              </shadow>
            </value>
            <value name="RATIO">
              <shadow type="math_number">
                <field name="NUM">0.5</field>
              </shadow>
            </value>
          </block>
        </category>
        <sep></sep>
        <category name="Variables" colour="%{BKY_VARIABLES_HUE}" custom="VARIABLE"></category>
        <category name="Functions" colour="%{BKY_PROCEDURES_HUE}" custom="PROCEDURE"></category>
        <sep></sep>
        <category name="Input/output" color="%{BKY_LOGIC_HUE}">
          <block type="token_auth"></block>
          <block type="message_get"></block>
          <block type="send_message"></block>
        </category>
    </xml>
      <script>
        // inject to workspace
        var workspace = Blockly.inject('blok',
                        {toolbox: document.getElementById('toolbox'),
                        grid:{
                            spacing: 20,
                            length: 3,
                            colour: '#ccc',
                            snap: true
                        },
                        trashcan: true
                        }
                        );
      </script>
      
        <button type="button" style="position:absolute;left:100;top:30px">
          <a href="start.html">Back</a>
        </button>
        
        <button type="button" id="save">
          <p style="position: relative; top: -8px;">Save</p>
        </button>
           
        <button type="button" id="load" style="position: absolute; top: 90px;">
          <p style="position: relative; top: -8px;">Load</p>
        </button>
          
        <button type="button" id="run" style="position: absolute; top: 120px;" onclick="run()">
          <p style="position: relative; top: -8px;">Run</p>
        </button>
           
        
      


    <script>
      // save file
      // required: electron, path and filesystem
      
      const electron = require('electron'); 
const path = require('path'); 
const fs = require('fs'); 
const dialog = electron.remote.dialog; 
  
var save = document.getElementById('save'); 

function run(){
  try{
    eval(Blockly.JavaScript.workspaceToCode(workspace));
  } catch (e) {
    console.log(e);
  }
}
var load = document.getElementById('load'); 
      load.addEventListener('click', (event) => { 
          console.log('Attempting to load from canvas...');
          dialog.showOpenDialog((fileNames) => {
              // fileNames is an array that contains all the selected
              if(fileNames === undefined){
                  console.log("No file selected: canvas");
                  return;
              }

              fs.readFile(filepath, 'utf-8', (err, data) => {
                  if(err){
                      dialog.showErrorBox("An error ocurred reading the file :", err.message);
                      return;
                  }

                  // Change how to handle the file content
                  Blockly.Xml.clearWorkspaceAndLoadFromXml(data, workspace)
                  console.log("The file content is : " + data);
              });
          });
      });
save.addEventListener('click', (event) => { 
    console.log("Opening save dialog")
    dialog.showSaveDialog({ 
        title: 'Save as', 
        defaultPath: path.join(__dirname, '../workspace/'), 
        buttonLabel: 'Save',  
        filters: [ 
            { 
                name: 'Valour Application Project', 
                extensions: ['vapp'] 
            }, ], 
        properties: [] 
    }).then(file => { 
        // if file was cancelled by the user, but why?
        console.log(file.canceled); 
        //the workspace to code (js)
        var code = Blockly.JavaScript.workspaceToCode(workspace);
        if (!file.canceled) { 
            console.log(file.filePath.toString());  
            fs.writeFile(file.filePath.toString(),  
                         code, function (err) { 
                if (err) throw err; 
                console.log('Saved!'); 
                console.log();
            });
            // this is ultra big pog brain moment, the workspace is going to dom, that goes to text(xml) 
            // and that is the formate we need
            var xmlwp = Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(workspace))
            console.log(xmlwp)
            fs.writeFile(file.filePath.toString() + ".xml",
                          xmlwp, function (err) { if (err) throw err});
          }
    }).catch(err => { 
        console.log(err)
        dialog.showErrorBox("There was an error saving:",err) 
    }); 
}); 

      //CUSTOM BLOCKS

      Blockly.Blocks['token_auth'] = {
        init: function() {
          this.appendValueInput("token")
              .setCheck(null)
              .appendField("token:");
          this.setInputsInline(false);
          this.setPreviousStatement(true, null);
          this.setNextStatement(true, null);
          this.setColour(230);
      this.setTooltip("get the token value");
      this.setHelpUrl("");
        }
      };
      Blockly.Blocks['send_message'] = {
      init: function() {
        this.appendValueInput("content")
          .setCheck("String")
          .appendField("Message content:");
        this.appendValueInput("author")
          .setCheck("null")
          .appendField("Token:");
        this.appendValueInput("path")
          .setCheck("String")
          .appendField("Message path:");
        this.setInputsInline(false);
        this.setPreviousStatement(true, null);
        this.setColour(230);
        this.setTooltip("Send the message.");
        this.setHelpUrl("");
      } 
    };

    Blockly.Blocks['message_get'] = {
     init: function() {
      this.appendValueInput("get")
        .setCheck(null)
        .appendField("Message received:");
       this.appendStatementInput("no")
        .setCheck(null)
        .appendField("do");
       this.setInputsInline(false);
       this.setColour(230);
       this.setTooltip("Start of a code block, executes when a message is caught.");
       this.setHelpUrl("");
      }
    };

    //CODE GENS

      Blockly.JavaScript['token_auth'] = function(block) {
        var value_name = Blockly.JavaScript.valueToCode(block, '', Blockly.JavaScript.ORDER_ATOMIC);
        var code = 'var token = ' + value_name + ';';
        return code
      }
      Blockly.JavaScript['send_message'] = function(block) {
        var value_content = Blockly.JavaScript.valueToCode(block, 'content', Blockly.JavaScript.ORDER_ATOMIC);
        var value_author = Blockly.JavaScript.valueToCode(block, 'author', Blockly.JavaScript.ORDER_ATOMIC);
        var value_path = Blockly.JavaScript.valueToCode(block, 'path', Blockly.JavaScript.ORDER_ATOMIC);
        // TODO: Assemble JavaScript into code variable.
        var code = '...;\n';
        return code;
      };

      Blockly.JavaScript['message_get'] = function(block) {
        var value_get = Blockly.JavaScript.valueToCode(block, 'get', Blockly.JavaScript.ORDER_ATOMIC);
        var statements_no = Blockly.JavaScript.statementToCode(block, 'no');
        // TODO: Assemble JavaScript into code variable.
        var code = '...;\n';
        return code;
      };
    </script>
</body>
</html>